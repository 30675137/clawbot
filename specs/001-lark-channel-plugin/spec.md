# 功能规格说明: 飞书消息渠道插件

**功能分支**: `001-lark-channel-plugin`
**创建日期**: 2026-01-30
**状态**: 草稿
**输入**: 为 Clawbot 添加飞书（Lark/Feishu）消息渠道支持

## 用户场景与测试 *(必填)*

### 用户故事 1 - 配置飞书渠道 (优先级: P1)

作为 Clawbot 用户，我希望能够通过配置向导将飞书应用连接到 Clawbot，以便我可以通过飞书与 AI 助手交互。

**优先级理由**: 这是使用飞书渠道的前提条件，没有配置就无法使用任何其他功能。

**独立测试**: 可以通过运行 `clawbot onboard` 并选择飞书渠道，输入 App ID 和 App Secret 来完整测试。成功后系统显示连接状态为已连接。

**验收场景**:

1. **Given** 用户已安装 Clawbot 且拥有飞书开放平台应用凭据，**When** 用户运行配置向导并输入 App ID 和 App Secret，**Then** 系统验证凭据有效性并保存配置
2. **Given** 用户输入了无效的凭据，**When** 系统尝试验证，**Then** 系统显示明确的错误信息并提示重新输入
3. **Given** 配置已完成，**When** 用户运行 `clawbot channels status`，**Then** 飞书渠道显示为已连接状态

---

### 用户故事 2 - 接收飞书消息 (优先级: P1)

作为 Clawbot 用户，我希望当有人在飞书中向我的机器人发送消息时，Clawbot 能够接收并处理这些消息。

**优先级理由**: 消息接收是双向通信的基础，与配置同为核心功能。

**独立测试**: 配置完成后，在飞书中向机器人发送一条文本消息，验证 Clawbot 网关日志中显示收到该消息。

**验收场景**:

1. **Given** 飞书渠道已配置且网关正在运行，**When** 用户在飞书私聊中向机器人发送文本消息，**Then** Clawbot 接收到消息并路由给 AI 助手处理
2. **Given** 飞书渠道已配置，**When** 用户在已添加机器人的群组中 @机器人 发送消息，**Then** Clawbot 接收到消息并识别为群组消息
3. **Given** 网关暂时离线，**When** 网关恢复在线，**Then** 系统能够处理恢复期间的消息（根据飞书事件重试机制）

---

### 用户故事 3 - 发送飞书消息 (优先级: P1)

作为 Clawbot 用户，我希望 AI 助手的回复能够通过飞书发送给我。

**优先级理由**: 消息发送是完成对话闭环的必要功能。

**独立测试**: 向飞书机器人发送问题后，验证 AI 助手的回复在飞书中正确显示。

**验收场景**:

1. **Given** 用户已向机器人发送消息且 AI 已生成回复，**When** 系统发送回复，**Then** 用户在飞书中收到格式正确的回复消息
2. **Given** AI 回复包含富文本格式（如代码块、列表），**When** 系统发送回复，**Then** 飞书中正确渲染富文本格式
3. **Given** 消息发送失败（如网络问题），**When** 系统检测到失败，**Then** 系统记录错误并根据配置进行重试

---

### 用户故事 4 - 群组消息支持 (优先级: P2)

作为 Clawbot 用户，我希望能够在飞书群组中使用机器人，让团队成员都能与 AI 助手交互。

**优先级理由**: 群组功能扩展了使用场景，但私聊功能已能满足基本需求。

**独立测试**: 将机器人添加到测试群组，多个用户分别 @机器人 提问，验证每个用户都能收到回复。

**验收场景**:

1. **Given** 机器人已被添加到群组，**When** 群成员 @机器人 发送消息，**Then** 机器人回复该消息并 @发送者
2. **Given** 群组中有多个用户同时提问，**When** 系统处理消息，**Then** 每个用户的问题都能得到独立回复
3. **Given** 用户在群组中发送消息但未 @机器人，**When** 系统接收消息，**Then** 系统忽略该消息（除非配置为响应所有消息）

---

### 用户故事 5 - 媒体消息支持 (优先级: P3)

作为 Clawbot 用户，我希望能够通过飞书发送图片给 AI 助手进行分析，并接收包含图片的回复。

**优先级理由**: 媒体支持增强了交互能力，但文本消息已能满足大部分使用场景。

**独立测试**: 向机器人发送一张图片并询问图片内容，验证 AI 能够分析图片并给出回复。

**验收场景**:

1. **Given** 用户发送图片消息给机器人，**When** 系统处理消息，**Then** 图片被下载并传递给 AI 进行分析
2. **Given** AI 回复需要包含图片，**When** 系统发送回复，**Then** 图片在飞书中正确显示
3. **Given** 用户发送文件附件，**When** 系统处理消息，**Then** 文件信息被记录并可供 AI 参考

---

### 边缘情况

- 当飞书 API 返回速率限制错误时，系统应实施退避重试策略
- 当 Access Token 过期时，系统应自动刷新 Token 而不中断服务
- 当收到不支持的消息类型（如视频、语音）时，系统应优雅处理并可选通知用户
- 当 Webhook 验证失败时，系统应记录详细错误信息以便排查
- 当群组消息量过大时，系统应能够处理并发请求而不丢失消息

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持通过 App ID 和 App Secret 配置飞书应用连接
- **FR-002**: 系统必须能够自动获取和刷新 Tenant Access Token
- **FR-003**: 系统必须能够接收飞书 Webhook 事件并验证事件签名
- **FR-004**: 系统必须支持发送文本消息到飞书私聊和群组
- **FR-005**: 系统必须支持发送富文本（post 格式）消息
- **FR-006**: 系统必须能够接收和处理私聊消息
- **FR-007**: 系统必须能够接收和处理群组中 @机器人 的消息
- **FR-008**: 系统必须提供渠道状态检查功能
- **FR-009**: 系统必须提供交互式配置向导（onboarding）
- **FR-010**: 系统必须支持接收和处理图片消息
- **FR-011**: 系统必须支持发送图片消息
- **FR-012**: 系统应支持可选的事件加密（Encrypt Key）
- **FR-013**: 系统应支持消息发送失败时的重试机制
- **FR-014**: 系统必须在回复超过飞书消息长度限制时自动分割为多条消息依次发送
- **FR-015**: 系统应在收到不支持的消息类型（视频、语音、表情包等）时记录日志并回复用户"暂不支持此消息类型"

### 关键实体

- **飞书应用配置**: 包含 App ID、App Secret、可选的加密密钥和验证 Token，用于与飞书 API 通信
- **飞书消息**: 包含消息 ID、发送者信息、消息内容、消息类型、会话信息（私聊/群组）
- **飞书会话**: 表示私聊或群组，包含会话 ID、会话类型、参与者信息
- **Access Token**: 用于 API 认证的令牌，包含令牌值和过期时间

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户能够在 5 分钟内完成飞书渠道的配置流程
- **SC-002**: 消息从飞书发送到收到 AI 回复的端到端延迟在正常情况下不超过 10 秒（不含 AI 处理时间）
- **SC-003**: 系统能够持续运行 24 小时以上而无需人工干预（Token 自动刷新）
- **SC-004**: 文本消息的发送成功率达到 99% 以上（排除飞书平台故障）
- **SC-005**: 群组消息能够正确识别发送者并进行独立会话管理
- **SC-006**: 媒体消息（图片）的处理成功率达到 95% 以上
- **SC-007**: 配置向导的首次完成率达到 90% 以上（用户无需查阅额外文档）

## 澄清记录

### 会话 2026-01-30

- Q: 当 AI 生成的回复超过飞书单条消息长度限制时，系统应如何处理？ → A: 自动分割为多条消息依次发送

## 假设

- 用户已在飞书开放平台创建了企业自建应用并获取了 App ID 和 App Secret
- 用户的网络环境能够接收来自飞书服务器的 Webhook 回调（公网可访问或已配置内网穿透）
- 飞书应用已配置必要的权限（消息读写、群组信息等）
- 初始版本使用 Tenant Access Token（应用身份），暂不支持 User Access Token（用户身份）
