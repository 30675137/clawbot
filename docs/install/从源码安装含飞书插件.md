# 从源码安装 Clawbot（含飞书插件）

本指南介绍如何从源码安装 Clawbot 并启用飞书（Lark）插件。

## 前置要求

- **Node.js 22+**（必须）
- **pnpm**（包管理器）
- **Git**

## 安装步骤

### 步骤 1：克隆仓库

```bash
git clone git@github.com:gstarwd/clawbot.git
cd clawbot
```

### 步骤 2：安装 pnpm（如果没有）

```bash
npm install -g pnpm
```

### 步骤 3：安装项目依赖

```bash
pnpm install
```

### 步骤 4：构建项目

```bash
# 构建 UI
pnpm ui:build

# 构建 TypeScript（跳过 A2UI 如果源文件缺失）
CLAWDBOT_A2UI_SKIP_MISSING=1 pnpm build
```

### 步骤 5：修复品牌重命名问题（如需要）

如果构建时遇到找不到 `clawbot-root.js` 或 `clawbot-tools.js` 的错误，需要创建符号链接：

```bash
# 在项目根目录执行
ln -sf moltbot-root.ts src/infra/clawbot-root.ts
ln -sf moltbot-tools.ts src/agents/clawbot-tools.ts
ln -sf moltbot.mjs clawbot.mjs
```

### 步骤 6：设置 pnpm 全局目录

```bash
pnpm setup
source ~/.zshrc  # 或 source ~/.bashrc
```

### 步骤 7：全局链接

```bash
pnpm link --global
```

### 步骤 8：确保使用 Node 22+

如果系统默认 Node 版本低于 22，可以通过以下方式安装：

**使用 Homebrew（macOS）：**
```bash
brew install node@22
export PATH="/opt/homebrew/opt/node@22/bin:$PATH"
```

**使用 Volta：**
```bash
volta install node@22
```

**使用 nvm：**
```bash
nvm install 22
nvm use 22
```

### 步骤 9：验证安装

```bash
clawbot --version
# 应该显示类似: 2026.1.27-beta.1
```

## 安装飞书插件

### 步骤 1：创建插件清单文件

在 `extensions/lark/` 目录下创建 `clawdbot.plugin.json`：

```json
{
  "id": "lark",
  "channels": [
    "lark"
  ],
  "configSchema": {
    "type": "object",
    "additionalProperties": false,
    "properties": {}
  }
}
```

### 步骤 2：安装插件

```bash
clawbot plugins install ./extensions/lark
```

### 步骤 3：验证插件安装

```bash
clawbot plugins list
```

应该看到 `lark` 插件状态为 `loaded`。

### 步骤 4：配置飞书

```bash
clawbot setup lark
```

## 常见问题

### 问：构建时报错 "Cannot find module '../infra/clawbot-root.js'"

**答：** 这是品牌重命名不完整导致的。执行以下命令创建符号链接：

```bash
ln -sf moltbot-root.ts src/infra/clawbot-root.ts
ln -sf moltbot-tools.ts src/agents/clawbot-tools.ts
ln -sf moltbot.mjs clawbot.mjs
```

### 问：构建时报错 "Missing A2UI bundle assets"

**答：** 设置环境变量跳过 A2UI 构建：

```bash
CLAWDBOT_A2UI_SKIP_MISSING=1 pnpm build
```

### 问：运行 clawbot 时报错 "clawbot requires Node >=22.0.0"

**答：** 升级 Node.js 到 22 或更高版本。参见步骤 8。

### 问：pnpm link --global 报错 "Unable to find the global bin directory"

**答：** 先运行 `pnpm setup`，然后重新加载 shell 配置：

```bash
pnpm setup
source ~/.zshrc  # 或 source ~/.bashrc
```

### 问：插件安装报错 "plugin already exists"

**答：** 删除已存在的插件目录后重新安装：

```bash
rm -rf ~/.clawdbot/extensions/lark
clawbot plugins install ./extensions/lark
```

## 开发环境 PATH 设置

为了方便开发，建议将以下内容添加到 `~/.zshrc` 或 `~/.bashrc`：

```bash
# Node 22 (Homebrew)
export PATH="/opt/homebrew/opt/node@22/bin:$PATH"

# pnpm 全局目录
export PNPM_HOME="$HOME/Library/pnpm"
export PATH="$PNPM_HOME:$PATH"
```

## 相关文档

- [飞书插件规格说明](../../specs/001-lark-channel-plugin/spec.md)
- [飞书插件快速入门](../../specs/001-lark-channel-plugin/quickstart.md)
- [插件管理](/cli/plugins)
