<!--
同步影响报告
==================
版本变更: 0.0.0 → 1.0.0 (初始批准)
修改的原则: 无 (初始版本)
新增章节:
  - 核心原则 (5 条原则)
  - 技术标准
  - 开发工作流
  - 治理规则
移除章节: 无
需要更新的模板:
  ✅ .specify/templates/plan-template.md - Constitution Check 部分兼容
  ✅ .specify/templates/spec-template.md - 需求与原则对齐
  ✅ .specify/templates/tasks-template.md - 任务阶段与工作流对齐
待办事项: 无
-->

# Clawbot 项目宪章

## 核心原则

### 一、渠道优先架构

Clawbot 是一个多渠道 AI 助手网关。每个功能都必须考虑其对所有支持的消息渠道的影响（WhatsApp、Telegram、Discord、Slack、Signal、iMessage、LINE、Teams、Matrix 及扩展渠道）。

- 新功能必须在所有核心渠道上保持一致的行为，除非技术上不可行
- 渠道特定的行为必须在渠道注册表（`src/channels/dock.ts`）中记录
- 扩展必须使用插件 SDK（`src/plugin-sdk/`）进行渠道集成
- 渠道能力、配置解析器和线程默认值必须在 dock 中注册

**理由**: 用户期望无论使用哪个消息平台都能获得一致的体验。渠道 dock 模式确保共享代码保持轻量，而每个渠道的插件处理复杂逻辑。

### 二、TypeScript 严格模式

所有代码必须使用 TypeScript 编写，并启用严格类型检查。禁止使用 `any` 类型，除非有充分的理由。

- 在系统边界使用 Zod 进行运行时模式验证
- 在工具定义中使用 TypeBox 生成 JSON Schema
- 公共 API 优先使用显式类型而非类型推断
- 文件保持在 500-700 行以内；当有助于清晰度或可测试性时进行拆分

**理由**: 严格类型检查在编译时捕获错误，改善 IDE 支持，并作为活文档。代码库的复杂性要求类型安全。

### 三、测试驱动质量

所有逻辑变更都必须进行测试。项目维持 70% 的行覆盖率、分支覆盖率、函数覆盖率和语句覆盖率阈值。

- 测试必须与源文件放在一起（`*.test.ts`）
- 端到端测试使用 `*.e2e.test.ts` 命名约定
- 推送任何逻辑变更前运行 `pnpm test`
- 实时测试（使用真实 API 密钥）使用 `CLAWDBOT_LIVE_TEST=1 pnpm test:live`
- 纯测试添加/修复不需要更新日志条目，除非它们改变了面向用户的行为

**理由**: 多渠道网关有许多集成点。全面的测试可防止 15+ 个支持平台的回归问题。

### 四、网关中心设计

网关是始终运行的控制平面。所有功能都必须尊重网关作为中央协调器的角色。

- 网关协议在单个端口上使用 WebSocket + HTTP
- 会话状态必须持久化到 `~/.clawdbot/sessions/`
- 配置变更必须在可行的情况下支持热重载
- 永远不要向外部消息平台发送流式/部分回复；只发送最终回复

**理由**: 用户将 clawbot 作为持久服务运行。网关模式实现可靠的消息路由、会话管理和优雅降级。

### 五、简洁优于巧妙

优先选择简单、直接的解决方案。避免过度工程化和过早抽象。

- 不要添加超出请求范围的功能、重构或"改进"
- 三行相似的代码优于过早的抽象
- 只在系统边界（用户输入、外部 API）进行验证
- 完全删除未使用的代码；避免向后兼容性的临时方案
- 使用现有模式（`createDefaultDeps`、CLI 进度工具、终端调色板）

**理由**: Clawbot 已经因多渠道支持而具有相当的复杂性。额外的复杂性必须由具体的、当前的需求来证明。

## 技术标准

### 运行时与工具链

- **Node.js**: 需要 22+ 版本
- **包管理器**: 首选 pnpm；支持 Bun 执行 TypeScript
- **代码检查**: Oxlint（`pnpm lint`）
- **代码格式化**: Oxfmt（`pnpm format`）
- **构建**: 通过 `pnpm build` 进行 TypeScript 编译
- **测试**: 使用 V8 覆盖率的 Vitest

### 代码组织

- 源代码位于 `src/`，CLI 连接代码位于 `src/cli/`
- 扩展/插件作为工作区包位于 `extensions/*`
- 文档位于 `docs/`（通过 Mintlify 托管在 docs.molt.bot）
- 测试与源文件放在一起

### 安全要求

- 永远不要提交真实的电话号码、API 密钥或实时配置值
- Web 提供者凭据存储在 `~/.clawdbot/credentials/`
- 在文档、测试和示例中使用明显的假占位符
- 验证和清理所有外部输入

## 开发工作流

### 提交标准

- 使用 `scripts/committer "<msg>" <file...>` 进行范围化提交
- 遵循简洁、面向行动的提交信息（例如 `CLI: add verbose flag to send`）
- 将相关变更分组；避免捆绑不相关的重构
- 面向用户的变更需要更新日志条目（包含 PR 编号和贡献者致谢）

### Pull Request 流程

- PR 需要总结范围、说明执行的测试，并提及面向用户的变更
- 当提交历史清晰时优先使用 rebase；当历史混乱时使用 squash
- 合并前在本地运行完整检查（`pnpm lint && pnpm build && pnpm test`）
- 将新贡献者添加到 README 的 clawtributors 部分

### 多代理安全

- 除非明确请求，否则不要创建/应用/删除 git stash 条目
- 除非明确请求，否则不要切换分支
- 除非明确请求，否则不要修改 git worktrees
- 专注于你的变更；当被告知"提交"时只提交那些变更

## 治理规则

本宪章优先于 clawbot 项目的所有其他开发实践。修订需要：

1. 记录提议的变更及其理由
2. 项目维护者的审查和批准
3. 任何破坏性变更的迁移计划
4. 遵循语义版本控制的版本递增：
   - MAJOR: 向后不兼容的原则移除或重新定义
   - MINOR: 新增原则/章节或实质性扩展
   - PATCH: 澄清、措辞或非语义性改进

所有 PR 和代码审查必须验证是否符合这些原则。超出这些标准的复杂性必须在 PR 描述中说明理由。

运行时开发指南位于仓库根目录的 `CLAUDE.md` 文件中。

**版本**: 1.0.0 | **批准日期**: 2026-01-30 | **最后修订**: 2026-01-30
